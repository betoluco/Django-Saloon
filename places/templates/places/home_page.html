{% extends "places/_base.html" %}
{% load staticfiles %}

{% block stylesheets %}
  {{block.super}}
  <link rel="stylesheet" type="text/css" href="{% static "places/css/google-maps.css" %}">
  <link rel="stylesheet" type="text/css" href="{% static "places/css/home-page.css" %}">
  <link rel="stylesheet" type="text/css" href="{% static "places/css/results.css" %}">
{% endblock %}

{% block javascript %}
  {{block.super}}
  <script type="text/javascript">
    function initLocationsMap() {
      console.log("function initLocationsMap()");
      mapOptions = {
        center: {lat: 19.2846923, lng: -99.649144},
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControl: false,
        streetViewControl: false,
      };
      var map = new google.maps.Map(document.getElementById('map'), mapOptions);

      var input = document.getElementById('pac-input');
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

      var initBounds = new google.maps.LatLngBounds();
      
      {% for place in places %}
        var marker = new google.maps.Marker({
          position:{lat: {{place.latitude_longitude.y}}, lng: {{place.latitude_longitude.x}}},
          map: map,
          title: "{{place.name}}"
        });
        initBounds.extend({lat: {{place.latitude_longitude.y}}, lng: {{place.latitude_longitude.x}}});
      {% endfor %}
      map.fitBounds(initBounds);

      autocompleteOptions = {types: ['geocode'], bounds: initBounds}
      var autocomplete = new google.maps.places.Autocomplete(input, autocompleteOptions);

      autocomplete.addListener('place_changed', function() {
        console.log("input chaged");
        var place = autocomplete.getPlace();
        var bounds = new google.maps.LatLngBounds();
        bounds.union(place.geometry.viewport);
        map.fitBounds(bounds);
      });

      map.addListener('idle', function(){
        console.log("load results");
        var bounds = new google.maps.LatLngBounds();
        var bounds = map.getBounds();
        var southWest =  new google.maps.LatLng();
        var southWest = bounds.getSouthWest();
        var northEast =  new google.maps.LatLng();
        var northEast = bounds.getNorthEast();
        $('#results').load('results/?swLat='+southWest.lat()+'&swLng='+southWest.lng()+'&neLat='+northEast.lat()+'&neLng='+northEast.lng());
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbVtEJlP2oDkRfEfFc2SVEE7Wj1kObrNs&libraries=places&callback=initLocationsMap"async defer></script>
{% endblock %}

{% block content %}
  <!--map-->
  <div id="jumbotron" class="jumbotron">
    <div class="container">
    <div class="row">
      <input id="pac-input" class="controls" type="text" placeholder="Buscador">
      <div id="map" class="col-md-8"></div>
    </div>
    </div>
  </div>

  <div id="results"></div>
{% endblock %}